#!/bin/sh
set -e

# Sync with bin/build, bin/test, & test/libcrypteia.sh.
export CRYPTEIA_BUILD_OS="${CRYPTEIA_BUILD_OS:=debian}"

# Auto-detect build target if not already set
if [ -z "${CRYPTEIA_BUILD_TARGET}" ]; then
  case "$(uname -m)" in
    aarch64)
      export CRYPTEIA_BUILD_TARGET="aarch64-unknown-linux-gnu"
      ;;
    x86_64)
      export CRYPTEIA_BUILD_TARGET="x86_64-unknown-linux-gnu"
      ;;
    *)
      echo "Unsupported architecture: $(uname -m)" >&2
      exit 1
      ;;
  esac
fi

if [ "${CRYPTEIA_BUILD_TARGET}" = "aarch64-unknown-linux-gnu" ]; then
  export CRYPTEIA_BUILD_SUFFIX="-arm64"
fi

if [ ! "${SKIP_CARGO_TEST}" = "1" ]; then
  cargo test --target "${CRYPTEIA_BUILD_TARGET}" --quiet
fi

# Language runtime tests now work on both architectures thanks to proper
# LD_PRELOAD path matching (CRYPTEIA_BUILD_SUFFIX) and installed runtimes
TEST_LANG=node ./test/libcrypteia.sh
TEST_LANG=ruby ./test/libcrypteia.sh
TEST_LANG=php ./test/libcrypteia.sh
TEST_LANG=python ./test/libcrypteia.sh
